#####################
# 16. WAF 로그 저장용 S3 버킷 생성
#####################

resource "aws_s3_bucket" "waf_logs" {
  bucket        = "waf-logs-bucket-whs"           # 생성할 S3 버킷 이름 (고유해야 함)
  force_destroy = true                            # 버킷 비우기 없이 삭제 허용 (테스트 환경에서 유용)
}

#####################
# 17. Kinesis Firehose 역할용 IAM Role 생성
#####################

resource "aws_iam_role" "firehose_role" {
  name = "KinesisFirehoseServiceRole"             # IAM Role 이름
  assume_role_policy = jsonencode({               # Firehose가 이 역할을 사용할 수 있도록 허용
    Version   = "2012-10-17",
    Statement = [{
      Effect    = "Allow",
      Principal = { Service = "firehose.amazonaws.com" },  # 신뢰할 서비스: Kinesis Firehose
      Action    = "sts:AssumeRole"
    }]
  })
}

#####################
# 18. IAM Role에 S3 접근 권한 부여
#####################

resource "aws_iam_role_policy" "firehose_policy" {
  role = aws_iam_role.firehose_role.id            # 위에서 만든 IAM 역할에 연결
  policy = jsonencode({
    Version   = "2012-10-17",
    Statement = [{
      Effect   = "Allow",
      Action   = [
        "s3:PutObject",                           # S3에 로그 객체 업로드 권한
        "s3:ListBucket"                           # 버킷 내부 목록 조회 권한
      ],
      Resource = [
        aws_s3_bucket.waf_logs.arn,              # 버킷 자체 권한
        "${aws_s3_bucket.waf_logs.arn}/*"         # 버킷 내부 모든 객체에 대한 권한
      ]
    }]
  })
}

#####################
# 19. Kinesis Firehose 스트림 생성
#####################

resource "aws_kinesis_firehose_delivery_stream" "waf_stream" {
  name        = "aws-waf-logs-siem"               # Firehose 스트림 이름
  destination = "extended_s3"                     # 로그 전송 대상: S3

  extended_s3_configuration {
    role_arn           = aws_iam_role.firehose_role.arn   # S3에 접근할 IAM 역할 ARN
    bucket_arn         = aws_s3_bucket.waf_logs.arn        # 로그를 저장할 S3 버킷 ARN
    compression_format = "GZIP"                            # 저장 시 압축 포맷 지정
    buffering_interval = 300                               # 300초(5분)마다 버퍼링된 로그 전송
    buffering_size     = 5                                 # 5MB 단위로 버퍼링하여 전송
    prefix             = "waf/"                            # S3 내부 저장 경로 접두어 (예: waf/YYYY/MM/DD/)
  }
}
