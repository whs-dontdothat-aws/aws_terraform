import json
import boto3
import os

waf = boto3.client('wafv2', region_name='ap-northeast-2')
IPSET_NAME = os.environ['IPSET_NAME']
IPSET_ID = os.environ['IPSET_ID']
SCOPE = os.environ.get('WAF_SCOPE', 'REGIONAL')

def lambda_handler(event, context):
    source_ip = event.get('ip')
    if not source_ip:
        return {"status": "failed", "reason": "No IP provided", "ip": "N/A"}

    try:
        response = waf.get_ip_set(Name=IPSET_NAME, Scope=SCOPE, Id=IPSET_ID)
        addresses = response['IPSet']['Addresses']
        lock_token = response['LockToken']
        ip_cidr = f"{source_ip}/32"

        if ip_cidr in addresses:
            return {"status": "skipped", "reason": "IP already exists", "ip": source_ip}

        addresses.append(ip_cidr)
        waf.update_ip_set(Name=IPSET_NAME, Scope=SCOPE, Id=IPSET_ID, Addresses=addresses, LockToken=lock_token)

        return {"status": "success", "message": f"{ip_cidr} added", "ip": source_ip}
    except Exception as e:
        return {"status": "error", "error": str(e), "ip": source_ip}