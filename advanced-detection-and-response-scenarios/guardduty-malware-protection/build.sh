#!/bin/bash
set -e

echo "[*] Cleaning up old zips..."
rm -f lambda_zips/*.zip
rm -rf lambda_zips/build

# 함수 목록
LAMBDA_FILES=(
  "abuseipdb_lookup_lambda.py"
  "discord_notify_lambda.py"
  "gateway_trigger_lambda.py"
  "ipset_add_lambda.py"
)

for FILE in "${LAMBDA_FILES[@]}"; do
  BASENAME=$(basename "$FILE" .py)
  ZIP="lambda_zips/${BASENAME}.zip"

  echo "[*] Building ${ZIP}..."

  mkdir -p lambda_zips/build
  cp "lambda_zips/${FILE}" lambda_zips/build/

  # requests가 필요한 함수만 dependencies 포함
  if [[ "$FILE" == "abuseipdb_lookup_lambda.py" || "$FILE" == "discord_notify_lambda.py" ]]; then
    echo "  [+] Installing dependencies for ${FILE}"
    pip install requests -t lambda_zips/build/
  fi

  (cd lambda_zips/build && zip -r "../${BASENAME}.zip" .)
  rm -rf lambda_zips/build
done

echo "[+] All Lambda ZIPs created successfully."
